<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Test</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="style.css" type="text/css" />

    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">

    <script src="js/jquery.js"></script>
    <script src="../../lib/netchart.js"></script>

</head>
<body>
    <!--  graph layout  -->
    <div id="chart" style="margin: 0 auto; clear:both;"></div>

    <div id="sidebar">
        <span id="state"></span>
    </div>

    <script type="text/javascript">

        var chart;

        $(document).ready(function() {

            //var initGraph = function() {

            // get numver of nodes so that graph will expand all
            var request = new XMLHttpRequest();
            var numOfNodes = 0;
            request.open('GET', '/Simulator/SimServlet?request=getNodesCount', false);
            request.send(null);
            //alert(request.status);
            if (request.status === 200) {
                //alert(request.responseText);
               // numOfNodes = parseInt(request.responseText);
            }
            //------------


            // get numver of nodes so that graph will expand all
            request = new XMLHttpRequest();
            var jsonFilePath = "";
            request.open('GET', '/Simulator/SimServlet?request=getJSONgraphData', false);
            request.send(null);
            if (request.status === 200) {
                jsonFilePath = request.responseText;
                jsonFilePath = jsonFilePath.replace("&#10;","");
                //alert("jsonPath: " + jsonFilePath);
            }
            //------------


            chartOptions = {
                height: 700,
                container: $("#chart")[0],
                navigation: {
                    mode: "focusnodes",
                    initialNodes: ["1"],
                    focusNodeExpansionRadius: 5, //numOfNodes,
                    focusHistoryRelevanceCooldown: 0.4,
                    numberOfFocusNodes: 1
                },
                data: {url: "data/test.json"},//jsonFilePath},
                style: {nodeRules: {
                        "radius": function(node) {
                            node.radius = Math.max(0.2, node.relevance);
                        },
                        "image": function(node) {

                            var image = null;
                            var sliceNo = 0;
                            var sliceSize = 239;
                            if (node.data.type == "pc")
                            {
                                //image = "./node-icons-pc.png";
                                image = "./pc.png";
                            }
                            else if (node.data.type == "switch")
                            {
                                //image = "./node-icons-switch.png";
                                image = "./switch.png";
                            }
                            else if (node.data.type == "router")
                            {
                                //image = "./node-icons-router.png";
                                image = "./router.png";
                            }
                            else if (node.data.type == "person")
                            {
                                image = "./node-icons-male.png";
                            }
                            else
                            {
                                image = "./node-icons-case.png";
                            }

                            if (node.data.foreign) {
                                sliceNo = 1;
                            } else {
                                sliceNo = 0;
                            }

                            node.image = image;
                            node.imageSlicing = [0, sliceNo * sliceSize, sliceSize, sliceSize];
                        }
                    }},
                events: {onClick: function(event) {
                        if (event.clickNode) {
                            chart.addFocusNode(event.clickNode.id);
                            var newTable = "<table class=\"table table-striped\">";
                            newTable += "<tr><td>ID</td><td>" + event.clickNode.id + "</td></tr>";
                            newTable += "<tr><td>Type</td><td>" + event.clickNode.data.type + "</td></tr>";
//                            newTable += "<tr><td>x</td><td>" + event.clickNode.x + "</td></tr>";
//                            newTable += "<tr><td>y</td><td>" + event.clickNode.y + "</td></tr>";
                            var request = new XMLHttpRequest();
                            request.open('GET', '/ServletFileUploadDownloadExample/SimServlet?request=getNodeInfo&node=' + event.clickNode.id, false); // `false` makes the request synchronous
                            request.send(null);
                            if (request.status === 200) {
                                //alert(request.responseText);
                                var res = request.responseText.split(",");
                                var line;
                                for (var i = 0; i < res.length; i++) {
                                    res[i] = res[i].replace("{", "");
                                    res[i] = res[i].replace("}", "");
                                    line = res[i].split("=");
                                    newTable += "<tr><td>" + line[0] + "</td><td>" + line[1] + "</td></tr>";
                                }
                                newTable += "</table>";
                                $("#state")[0].innerHTML = newTable;
                            }

                        }
                        event.preventDefault();
                    }}
            };

            chart = new NetChart(chartOptions);
            //    }


            function sendMessageList(result) {
                $('#runOneStepInScenario', parent.document).attr("disabled", "disabled");
                $('#runFullScenario', parent.document).attr("disabled", "disabled");

                //result = "20,3,,12,3,14";
                var messagesList = result.split(",,");

                var ifStop = false;
                var oneHasMore;
                var time = 0;


                while (!ifStop) {
                    oneHasMore = false;
                    for (var i = 0; i < messagesList.length; i++) {
                        var allSourceAndTarget = messagesList[i].split(",");

                        // go over nodes list
                        if (messagesList[i] == "e")
                            continue;

                        var source = allSourceAndTarget[0];
                        var target = allSourceAndTarget[1];

                        if (allSourceAndTarget.length > 2) {
                            oneHasMore = true;
                            // remove first node from list
                            messagesList[i] = allSourceAndTarget.splice(1).toString();
                        }
                        else {
                            messagesList[i] = "e";
                        }

                        (function(source1, target1)
                        {
                            setTimeout(function()
                            {
                                chart.runMovingMessage(source1, target1);
                            }, time);
                        })(source, target);
                    }
                    time = time + 1000;

                    // if nobody has more nodes, stop.
                    if (oneHasMore == false) {
                        ifStop = true;
                    }
                }

                $('#runOneStepInScenario', parent.document).removeAttr("disabled");
                $('#runFullScenario', parent.document).removeAttr("disabled");
            }

        });
    </script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
</body>
</html>
