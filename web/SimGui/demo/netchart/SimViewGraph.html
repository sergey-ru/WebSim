<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Test</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="style.css" type="text/css" />

    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">

    <script src="js/jquery.js"></script>
    <script src="../../lib/netchart.js"></script>

</head>
<body>
    <!--  graph layout  -->
    <div id="chart" style="margin: 0 auto; clear:both;"></div>

    <div id="sidebar">
        <span id="state"></span>
        <span id="sendMessageForm">
            <form class="form-inline" role="form">
                <div class="form-group">
                    <label class="sr-only" for="exampleInputEmail2">Node Id 1</label>
                    <input type="text" class="form-control input-sm" id="nodeid1">
                </div>
                <div class="form-group">
                    <label class="sr-only" for="exampleInputPassword2">Node Id 2</label>
                    <input type="text" class="form-control input-sm" id="nodeid2">
                </div>
                <button type="submit" id="sendAMessage" class="btn btn-default">Send</button>
            </form>
        </span>
    </div>

    <script type="text/javascript">
//        parent.childGetElementById = function(id) {
//            return document.getElementById(id);
//        }
//        parent.childLoaded();

        $(document).ready(function() {
            chartOptions = {
                height: 700,
                container: $("#chart")[0],
                navigation: {
                    mode: "focusnodes",
                    initialNodes: ["1", "2", "3"],
                    focusNodeExpansionRadius: 1,
                    focusHistoryRelevanceCooldown: 0.4,
                    numberOfFocusNodes: 2
                },
                data: {url: "data/test.json"},
                style: {nodeRules: {
                        "radius": function(node) {
                            node.radius = Math.max(0.2, node.relevance);
                        },
                        "image": function(node) {

                            var image = null;
                            var sliceNo = 0;
                            var sliceSize = 239;
                            if (node.data.type == "pc")
                            {
                                //image = "./node-icons-pc.png";
                                image = "./pc.png";
                            }
                            else if (node.data.type == "switch")
                            {
                                //image = "./node-icons-switch.png";
                                image = "./switch.png";
                            }
                            else if (node.data.type == "router")
                            {
                                //image = "./node-icons-router.png";
                                image = "./router.png";
                            }
                            else if (node.data.type == "person")
                            {
                                image = "./node-icons-male.png";
                            }
                            else
                            {
                                image = "./node-icons-case.png";
                            }

                            if (node.data.foreign) {
                                sliceNo = 1;
                            } else {
                                sliceNo = 0;
                            }

                            node.image = image;
                            node.imageSlicing = [0, sliceNo * sliceSize, sliceSize, sliceSize];
                        }
                    }},
                events: {onClick: function(event) {
                        if (event.clickNode) {
                            chart.addFocusNode(event.clickNode.id);
                            var newTable = "<table class=\"table table-striped\">";
                            newTable += "<tr><td>ID</td><td>" + event.clickNode.id + "</td></tr>";
                            newTable += "<tr><td>Type</td><td>" + event.clickNode.data.type + "</td></tr>";
                            newTable += "<tr><td>x</td><td>" + event.clickNode.x + "</td></tr>";
                            newTable += "<tr><td>y</td><td>" + event.clickNode.y + "</td></tr>";
                            var request = new XMLHttpRequest();
                            request.open('GET', '/ServletFileUploadDownloadExample/SimServlet?request=getNodeInfo&node=' + event.clickNode.id, false); // `false` makes the request synchronous
                            request.send(null);
                            if (request.status === 200) {
                                //alert(request.responseText);
                                var res = request.responseText.split(",");
                                var line;
                                for (var i = 0; i < res.length; i++) {
                                    res[i] = res[i].replace("{", "");
                                    res[i] = res[i].replace("}", "");
                                    line = res[i].split("=");
                                    newTable += "<tr><td>" + line[0] + "</td><td>" + line[1] + "</td></tr>";
                                }
                                newTable += "</table>";
                                $("#state")[0].innerHTML = newTable;
                            }

                        }
//                        if (event.clickLink) {
//                            var newTable = "<table class=\"table table-striped\">";
//                            newTable += "<tr><td>ID</td><td>" + event.clickLink.Base_Animator() + "</td></tr>";
//                            newTable += "<tr><td>x</td><td>" + event.clickLink.x0 + "</td></tr>";
//                            newTable += "<tr><td>y</td><td>" + event.clickLink.x1 + "</td></tr>";
//                            newTable += "</table>";
//
//                            $("#state")[0].innerHTML = newTable;
//                        }
                        event.preventDefault();
                    }}
            };

            chart = new NetChart(chartOptions);

            //chart.expandNode("3");
            //chart.runMovingMessage("1", "2");
//            setTimeout(function() {
//                chart.runMovingMessage("2", "3");
//                setTimeout(function() {
//                    chart.runMovingMessage("3", "15");
//                }, 2200);
//            }, 2200);

            $("#sendAMessage").click(function(e) {
                e.preventDefault();
                var source = $("#nodeid1").val();
                var terget = $("#nodeid2").val();
                //alert(source);
                //alert(terget);

                var request = new XMLHttpRequest();
                request.open('GET', '/ServletFileUploadDownloadExample/SimServlet?request=getShortestPath&source=' + source + "&target=" + terget, false); // `false` makes the request synchronous
                request.send(null);
                if (request.status === 200) {
                    //alert(request.responseText);

                    // split the path
                    var result = request.responseText;
                    result = result.replace("]", "");
                    result = result.replace("[", "");
                    result = result.split(",");

                    // sending firts message from source to nextStep
                    //alert("from " + source + " to " + result[0]);
                    chart.runMovingMessage(source, result[0]);

                    function runner(i) {

                        //alert("i:" + i);
                        //alert("result.length - 1:" + ((result.length) - 1));

                        if (i == ((result.length) - 1))
                            return;

                        setTimeout(function() {

                            //alert("from " + result[i].replace(" ", "") + " to " + result[i + 1].replace(" ", ""));
                            chart.runMovingMessage(result[i].replace(" ", ""), result[i + 1].replace(" ", ""));
                            runner(i + 1);

                        }, 1000);
                    }

                    runner(0);
                }
            });

        });
    </script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
</body>
</html>
